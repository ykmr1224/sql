<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AvgAggregator.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">core</a> &gt; <a href="index.source.html" class="el_package">org.opensearch.sql.expression.aggregation</a> &gt; <span class="el_source">AvgAggregator.java</span></div><h1>AvgAggregator.java</h1><pre class="source lang-java linenums">/*
 * Copyright OpenSearch Contributors
 * SPDX-License-Identifier: Apache-2.0
 */

package org.opensearch.sql.expression.aggregation;

import static java.time.temporal.ChronoUnit.MILLIS;
import static org.opensearch.sql.utils.ExpressionUtils.format;

import java.time.Instant;
import java.time.LocalTime;
import java.util.List;
import java.util.Locale;
import org.opensearch.sql.data.model.ExprDateValue;
import org.opensearch.sql.data.model.ExprDoubleValue;
import org.opensearch.sql.data.model.ExprIntegerValue;
import org.opensearch.sql.data.model.ExprNullValue;
import org.opensearch.sql.data.model.ExprTimeValue;
import org.opensearch.sql.data.model.ExprTimestampValue;
import org.opensearch.sql.data.model.ExprValue;
import org.opensearch.sql.data.type.ExprCoreType;
import org.opensearch.sql.expression.DSL;
import org.opensearch.sql.expression.Expression;
import org.opensearch.sql.expression.function.BuiltinFunctionName;

/**
 * The average aggregator aggregate the value evaluated by the expression. If the expression
 * evaluated result is NULL or MISSING, then the result is NULL.
 */
public class AvgAggregator extends Aggregator&lt;AvgAggregator.AvgState&gt; {

  /**
   * To process by different ways different data types, we need to store the type. Input data has
   * the same type as the result.
   */
  private final ExprCoreType dataType;

  public AvgAggregator(List&lt;Expression&gt; arguments, ExprCoreType returnType) {
<span class="fc" id="L40">    super(BuiltinFunctionName.AVG.getName(), arguments, returnType);</span>
<span class="fc" id="L41">    dataType = returnType;</span>
<span class="fc" id="L42">  }</span>

  @Override
  public AvgState create() {
<span class="fc bfc" id="L46" title="All 5 branches covered.">    switch (dataType) {</span>
      case DATE:
<span class="fc" id="L48">        return new DateAvgState();</span>
      case TIMESTAMP:
<span class="fc" id="L50">        return new TimestampAvgState();</span>
      case TIME:
<span class="fc" id="L52">        return new TimeAvgState();</span>
      case DOUBLE:
<span class="fc" id="L54">        return new DoubleAvgState();</span>
      default: // unreachable code - we don't expose signatures for unsupported types
<span class="fc" id="L56">        throw new IllegalArgumentException(</span>
<span class="fc" id="L57">            String.format(&quot;avg aggregation over %s type is not supported&quot;, dataType));</span>
    }
  }

  @Override
  protected AvgState iterate(ExprValue value, AvgState state) {
<span class="fc" id="L63">    return state.iterate(value);</span>
  }

  @Override
  public String toString() {
<span class="fc" id="L68">    return String.format(Locale.ROOT, &quot;avg(%s)&quot;, format(getArguments()));</span>
  }

  /** Average State. */
  protected abstract static class AvgState implements AggregationState {
    protected ExprValue count;
    protected ExprValue total;

<span class="fc" id="L76">    AvgState() {</span>
<span class="fc" id="L77">      this.count = new ExprIntegerValue(0);</span>
<span class="fc" id="L78">      this.total = new ExprDoubleValue(0D);</span>
<span class="fc" id="L79">    }</span>

    @Override
    public abstract ExprValue result();

    protected AvgState iterate(ExprValue value) {
<span class="fc" id="L85">      count = DSL.add(DSL.literal(count), DSL.literal(1)).valueOf();</span>
<span class="fc" id="L86">      return this;</span>
    }
  }

<span class="fc" id="L90">  protected static class DoubleAvgState extends AvgState {</span>
    @Override
    public ExprValue result() {
<span class="fc bfc" id="L93" title="All 2 branches covered.">      if (0 == count.integerValue()) {</span>
<span class="fc" id="L94">        return ExprNullValue.of();</span>
      }
<span class="fc" id="L96">      return DSL.divide(DSL.literal(total), DSL.literal(count)).valueOf();</span>
    }

    @Override
    protected AvgState iterate(ExprValue value) {
<span class="fc" id="L101">      total = DSL.add(DSL.literal(total), DSL.literal(value)).valueOf();</span>
<span class="fc" id="L102">      return super.iterate(value);</span>
    }
  }

<span class="fc" id="L106">  protected static class DateAvgState extends AvgState {</span>
    @Override
    public ExprValue result() {
<span class="fc bfc" id="L109" title="All 2 branches covered.">      if (0 == count.integerValue()) {</span>
<span class="fc" id="L110">        return ExprNullValue.of();</span>
      }

<span class="fc" id="L113">      return new ExprDateValue(</span>
          new ExprTimestampValue(
<span class="fc" id="L115">                  Instant.ofEpochMilli(</span>
<span class="fc" id="L116">                      DSL.divide(DSL.literal(total), DSL.literal(count)).valueOf().longValue()))</span>
<span class="fc" id="L117">              .dateValue());</span>
    }

    @Override
    protected AvgState iterate(ExprValue value) {
<span class="fc" id="L122">      total =</span>
<span class="fc" id="L123">          DSL.add(DSL.literal(total), DSL.literal(value.timestampValue().toEpochMilli())).valueOf();</span>
<span class="fc" id="L124">      return super.iterate(value);</span>
    }
  }

<span class="fc" id="L128">  protected static class TimestampAvgState extends AvgState {</span>
    @Override
    public ExprValue result() {
<span class="fc bfc" id="L131" title="All 2 branches covered.">      if (0 == count.integerValue()) {</span>
<span class="fc" id="L132">        return ExprNullValue.of();</span>
      }

<span class="fc" id="L135">      return new ExprTimestampValue(</span>
<span class="fc" id="L136">          Instant.ofEpochMilli(</span>
<span class="fc" id="L137">              DSL.divide(DSL.literal(total), DSL.literal(count)).valueOf().longValue()));</span>
    }

    @Override
    protected AvgState iterate(ExprValue value) {
<span class="fc" id="L142">      total =</span>
<span class="fc" id="L143">          DSL.add(DSL.literal(total), DSL.literal(value.timestampValue().toEpochMilli())).valueOf();</span>
<span class="fc" id="L144">      return super.iterate(value);</span>
    }
  }

<span class="fc" id="L148">  protected static class TimeAvgState extends AvgState {</span>
    @Override
    public ExprValue result() {
<span class="fc bfc" id="L151" title="All 2 branches covered.">      if (0 == count.integerValue()) {</span>
<span class="fc" id="L152">        return ExprNullValue.of();</span>
      }

<span class="fc" id="L155">      return new ExprTimeValue(</span>
<span class="fc" id="L156">          LocalTime.MIN.plus(</span>
<span class="fc" id="L157">              DSL.divide(DSL.literal(total), DSL.literal(count)).valueOf().longValue(), MILLIS));</span>
    }

    @Override
    protected AvgState iterate(ExprValue value) {
<span class="fc" id="L162">      total =</span>
<span class="fc" id="L163">          DSL.add(DSL.literal(total), DSL.literal(MILLIS.between(LocalTime.MIN, value.timeValue())))</span>
<span class="fc" id="L164">              .valueOf();</span>
<span class="fc" id="L165">      return super.iterate(value);</span>
    }
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>