name: Publish HTML Reports

on:
  workflow_call:
    inputs:
      artifact-pattern:
        description: 'Pattern to match artifact names to download (e.g., "test-reports-*" or "html-reports-*")'
        required: false
        type: string
        default: 'test-reports-*'
      destination-dir:
        description: 'Directory name for GitHub Pages deployment (e.g., "run-123-abc123" or "revision-abc123")'
        required: false
        type: string
        default: '${{ github.run_number }}-${{ github.sha }}'
      keep-files:
        description: 'Whether to keep existing files in gh-pages branch'
        required: false
        type: boolean
        default: true
      needs-jobs:
        description: 'Comma-separated list of job names that this workflow depends on'
        required: false
        type: string
        default: ''

jobs:
  publish-html-reports:
    runs-on: ubuntu-latest
    steps:
    # Download all the artifacts from the previous jobs
    - name: Download HTML Report Artifacts
      uses: actions/download-artifact@v4
      with:
        pattern: ${{ inputs.artifact-pattern }}
        path: downloaded-artifacts
        merge-multiple: true

    # Collect all HTML reports from artifacts and workspace
    - name: Collect HTML reports
      run: |
        mkdir -p site
        
        # Copy artifacts from downloaded artifacts
        if [ -d "downloaded-artifacts" ]; then
          echo "📦 Copying artifacts from downloaded-artifacts/"
          cp -r downloaded-artifacts/* site/ 2>/dev/null || true
        fi
        
        # Find and copy all HTML files from common report directories
        echo "🔍 Searching for HTML reports in common locations..."
        
        # Common patterns for HTML reports
        patterns=(
          "*/build/reports/**/*.html"
          "*/build/test-results/**/*.html"
          "*/target/surefire-reports/*.html"
          "*/target/site/**/*.html"
          "**/coverage/**/*.html"
          "**/jacoco/**/*.html"
          "*/integ-test/build/reports/**/*.html"
        )
        
        for pattern in "${patterns[@]}"; do
          find . -path "$pattern" -type f 2>/dev/null | while read file; do
            if [ -f "$file" ]; then
              target_dir="site/$(dirname "${file#./}")"
              mkdir -p "$target_dir"
              cp "$file" "$target_dir/"
              echo "  📄 Copied: $file"
            fi
          done
        done
        
        echo "✅ Collected all artifacts and reports into 'site' directory."
        
        # Show what we collected
        report_count=$(find site -name "*.html" -type f | wc -l)
        echo "📊 Total HTML files collected: $report_count"
        
        if [ "$report_count" -gt 0 ]; then
          echo "📋 HTML files found:"
          find site -name "*.html" -type f | sort | head -20 | while read file; do
            echo "  - ${file#site/}"
          done
          if [ "$report_count" -gt 20 ]; then
            echo "  ... and $((report_count - 20)) more files"
          fi
        fi

    # Generate an index.html that links every folder/file
    - name: Generate directory listing
      uses: jayanta525/github-pages-directory-listing@v4.0.0
      with:
        FOLDER: site

    # Publish to gh-pages using the industry-standard action
    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v4
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_branch: gh-pages
        publish_dir: site
        destination_dir: ${{ inputs.destination-dir }}
        keep_files: ${{ inputs.keep-files }}

    # Add a clickable link in the run summary
    - name: Summary
      run: |
        SHORT_COMMIT="${{ github.sha }}"
        SHORT_COMMIT="${SHORT_COMMIT:0:8}"
        URL="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/${{ inputs.destination-dir }}/"
        
        {
          echo "### 📊 HTML Reports Published"
          echo ""
          echo "- **📋 Dashboard:** [$URL]($URL)"
          echo "- **🔍 Revision:** ${SHORT_COMMIT}"
          echo "- **🌿 Branch:** ${{ github.head_ref || github.ref_name }}"
          echo "- **📅 Generated:** $(date -u)"
          echo "- **📁 Destination:** ${{ inputs.destination-dir }}"
          echo ""
          
          # Show artifact pattern used
          echo "**Artifact Pattern:** \`${{ inputs.artifact-pattern }}\`"
          echo ""
          
          # Show search locations
          echo "**Search Locations:**"
          echo "- \`*/build/reports/**/*.html\`"
          echo "- \`*/build/test-results/**/*.html\`"
          echo "- \`*/target/surefire-reports/*.html\`"
          echo "- \`*/target/site/**/*.html\`"
          echo "- \`**/coverage/**/*.html\`"
          echo "- \`**/jacoco/**/*.html\`"
          echo "- \`*/integ-test/build/reports/**/*.html\`"
        } >> "$GITHUB_STEP_SUMMARY"
