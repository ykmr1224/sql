name: Publish HTML Reports

on:
  workflow_call:
    inputs:
      artifact-pattern:
        description: 'Pattern to match artifact names to download (e.g., "test-reports-*" or "html-reports-*")'
        required: false
        type: string
        default: 'test-reports-*'
      destination-dir:
        description: 'Directory name for GitHub Pages deployment (e.g., "12345678" or "revision-abc123")'
        required: false
        type: string
        default: '${{ github.run_id }}'
      keep-files:
        description: 'Whether to keep existing files in gh-pages branch'
        required: false
        type: boolean
        default: true
      needs-jobs:
        description: 'Comma-separated list of job names that this workflow depends on'
        required: false
        type: string
        default: ''

jobs:
  publish-html-reports:
    runs-on: ubuntu-latest
    steps:
    # Download all the artifacts from the previous jobs
    - name: Download HTML Report Artifacts
      uses: actions/download-artifact@v4
      with:
        pattern: ${{ inputs.artifact-pattern }}
        path: downloaded-artifacts
        merge-multiple: true

    # Collect all HTML reports from artifacts and workspace
    - name: Collect artifacts
      run: |
        mkdir -p site
        cp -r downloaded-artifacts/* site/
        echo "Collected all artifacts into 'site' directory."

    # 👇 generate an index.html that links every folder/file
    - name: Generate directory listing
      uses: jayanta525/github-pages-directory-listing@v4.0.0
      with:
        FOLDER: site

    # Publish to gh-pages using the industry-standard action
    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v4
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_branch: gh-pages
        publish_dir: site
        destination_dir: ${{ inputs.destination-dir }}
        keep_files: ${{ inputs.keep-files }}

    # Add a clickable link in the run summary
    - name: Summary
      run: |
        SHORT_COMMIT="${{ github.sha }}"
        SHORT_COMMIT="${SHORT_COMMIT:0:8}"
        URL="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/${{ inputs.destination-dir }}/"
        
        {
          echo "### 📊 HTML Reports Published"
          echo ""
          echo "- **📋 Dashboard:** [$URL]($URL)"
          echo "- **🔍 Revision:** ${SHORT_COMMIT}"
          echo "- **🌿 Branch:** ${{ github.head_ref || github.ref_name }}"
          echo "- **📅 Generated:** $(date -u)"
        } >> "$GITHUB_STEP_SUMMARY"
