<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>NoFieldQuery.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">opensearch</a> &gt; <a href="index.source.html" class="el_package">org.opensearch.sql.opensearch.storage.script.filter.lucene.relevance</a> &gt; <span class="el_source">NoFieldQuery.java</span></div><h1>NoFieldQuery.java</h1><pre class="source lang-java linenums">/*
 * Copyright OpenSearch Contributors
 * SPDX-License-Identifier: Apache-2.0
 */

package org.opensearch.sql.opensearch.storage.script.filter.lucene.relevance;

import java.util.List;
import java.util.Map;
import java.util.stream.Collectors;
import org.opensearch.index.query.QueryBuilder;
import org.opensearch.sql.common.antlr.SyntaxCheckException;
import org.opensearch.sql.exception.SemanticCheckException;
import org.opensearch.sql.expression.FunctionExpression;
import org.opensearch.sql.expression.NamedArgumentExpression;

/**
 * Base class to represent relevance queries that have no 'fields' array as an argument.
 *
 * @param &lt;T&gt; The builder class for the OpenSearch query.
 */
abstract class NoFieldQuery&lt;T extends QueryBuilder&gt; extends RelevanceQuery&lt;T&gt; {
  public NoFieldQuery(Map&lt;String, QueryBuilderStep&lt;T&gt;&gt; queryBuildActions) {
<span class="fc" id="L24">    super(queryBuildActions);</span>
<span class="fc" id="L25">  }</span>

  @Override
  protected void ignoreArguments(List&lt;NamedArgumentExpression&gt; arguments) {
<span class="fc" id="L29">    arguments.removeIf(a -&gt; a.getArgName().equalsIgnoreCase(&quot;query&quot;));</span>
<span class="fc" id="L30">  }</span>

  @Override
  protected void checkValidArguments(String argNormalized, T queryBuilder) {
<span class="fc bfc" id="L34" title="All 2 branches covered.">    if (!getQueryBuildActions().containsKey(argNormalized)) {</span>
<span class="fc" id="L35">      throw new SemanticCheckException(</span>
<span class="fc" id="L36">          String.format(&quot;Parameter %s is invalid for %s function.&quot;, argNormalized, getQueryName()));</span>
    }
<span class="fc" id="L38">  }</span>

  /**
   * Override build function because RelevanceQuery requires 2 fields, but NoFieldQuery must have no
   * fields.
   *
   * @param func : Contains function name and passed in arguments.
   * @return : QueryBuilder object
   */
  @Override
  public QueryBuilder build(FunctionExpression func) {
<span class="fc" id="L49">    var arguments =</span>
<span class="fc" id="L50">        func.getArguments().stream()</span>
<span class="fc" id="L51">            .map(a -&gt; (NamedArgumentExpression) a)</span>
<span class="fc" id="L52">            .collect(Collectors.toList());</span>
<span class="fc bfc" id="L53" title="All 2 branches covered.">    if (arguments.size() &lt; 1) {</span>
<span class="fc" id="L54">      throw new SyntaxCheckException(</span>
<span class="fc" id="L55">          String.format(&quot;%s requires at least one parameter&quot;, func.getFunctionName()));</span>
    }

<span class="fc" id="L58">    return loadArguments(arguments);</span>
  }

  @Override
  public T createQueryBuilder(List&lt;NamedArgumentExpression&gt; arguments) {
    // Extract 'query'
<span class="fc" id="L64">    var query =</span>
<span class="fc" id="L65">        arguments.stream()</span>
<span class="fc" id="L66">            .filter(a -&gt; a.getArgName().equalsIgnoreCase(&quot;query&quot;))</span>
<span class="fc" id="L67">            .findFirst()</span>
<span class="fc" id="L68">            .orElseThrow(() -&gt; new SemanticCheckException(&quot;'query' parameter is missing&quot;));</span>

<span class="fc" id="L70">    return createBuilder(query.getValue().valueOf().stringValue());</span>
  }

  protected abstract T createBuilder(String query);
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>